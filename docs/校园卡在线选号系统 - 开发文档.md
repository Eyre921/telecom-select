**ç‰ˆæœ¬ï¼š** V1.0-Production

**åˆ›å»ºæ—¶é—´ï¼š** 2025å¹´8æœˆ

**æŠ€æœ¯æ ˆï¼š** Next.js 14 + TypeScript + Prisma + SQLite

  

## 1. é¡¹ç›®æ¦‚è¿°

  

### 1.1 æŠ€æœ¯æ¶æ„

  

æœ¬é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„å…¨æ ˆWebå¼€å‘æŠ€æœ¯æ ˆï¼š

  

- **å‰ç«¯æ¡†æ¶ï¼š** Next.js 14 (App Router)
    
- **å¼€å‘è¯­è¨€ï¼š** TypeScript
    
- **æ ·å¼æ¡†æ¶ï¼š** Tailwind CSS
    
- **æ•°æ®åº“ORMï¼š** Prisma
    
- **æ•°æ®åº“ï¼š** SQLite (ç”Ÿäº§ç¯å¢ƒå¯åˆ‡æ¢PostgreSQL)
    
- **èº«ä»½è®¤è¯ï¼š** NextAuth.js
    
- **éƒ¨ç½²æ–¹å¼ï¼š** PM2 + Standaloneæ¨¡å¼
    
      
    

### 1.2 é¡¹ç›®ç»“æ„

  

```Plain
telecom-select-system/
â”œâ”€â”€ prisma/                    # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ schema.prisma         # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ dev.db               # SQLiteæ•°æ®åº“æ–‡ä»¶
â”‚   â””â”€â”€ migrations/          # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                 # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ api/            # APIè·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/       # èº«ä»½è®¤è¯API
â”‚   â”‚   â”‚   â”œâ”€â”€ numbers/    # å·ç ç®¡ç†API
â”‚   â”‚   â”‚   â”œâ”€â”€ orders/     # è®¢å•ç®¡ç†API
â”‚   â”‚   â”‚   â””â”€â”€ admin/      # ç®¡ç†å‘˜API
â”‚   â”‚   â”œâ”€â”€ admin/          # ç®¡ç†åå°é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/  # ä»ªè¡¨ç›˜
â”‚   â”‚   â”‚   â””â”€â”€ import/     # æ•°æ®å¯¼å…¥
â”‚   â”‚   â”œâ”€â”€ signin/         # ç™»å½•é¡µé¢
â”‚   â”‚   â””â”€â”€ page.tsx        # å®¢æˆ·ç«¯é¦–é¡µ
â”‚   â”œâ”€â”€ components/         # Reactç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/            # é€šç”¨UIç»„ä»¶
â”‚   â”‚   â””â”€â”€ admin/         # ç®¡ç†åå°ç»„ä»¶
â”‚   â”œâ”€â”€ lib/               # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ auth.ts        # è®¤è¯é…ç½®
â”‚   â”‚   â”œâ”€â”€ prisma.ts      # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ utils.ts       # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ types/             # TypeScriptç±»å‹å®šä¹‰
â””â”€â”€ package.json          # é¡¹ç›®ä¾èµ–
```

  

## 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

  

### 2.1 æ•°æ®åº“è®¾è®¡

  

#### 2.1.1 æ ¸å¿ƒè¡¨ç»“æ„

  

**PhoneNumber è¡¨ï¼ˆå·ç è¡¨ï¼‰**

  

```TypeScript
model PhoneNumber {
  id                  String             @id @default(cuid())
  phoneNumber         String             @unique
  isPremium           Boolean            @default(false)
  premiumReason       String?
  reservationStatus   ReservationStatus  @default(UNRESERVED)
  orderTimestamp      DateTime?
  paymentAmount       Float?
  paymentMethod       PaymentMethod?
  transactionId       String?
  assignedMarketer    String?
  customerName        String?
  customerContact     String?
  shippingAddress     String?
  emsTrackingNumber   String?
  deliveryStatus      DeliveryStatus?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}
```

  

**User è¡¨ï¼ˆç”¨æˆ·è¡¨ï¼‰**

  

```TypeScript
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  password      String?   // åŠ å¯†å­˜å‚¨
  role          Role      @default(MARKETER)
  // NextAuth.js å…³è”è¡¨
  accounts      Account[]
  sessions      Session[]
}
```

  

#### 2.1.2 æšä¸¾ç±»å‹

  

```TypeScript
enum ReservationStatus {
  UNRESERVED      // æœªé¢„å®š
  PENDING_REVIEW  // å®¡æ ¸ä¸­
  RESERVED        // å·²é¢„å®š
}

enum PaymentMethod {
  WECHAT   // å¾®ä¿¡
  ALIPAY   // æ”¯ä»˜å®
  CASH     // ç°é‡‘
  OTHER    // å…¶ä»–
}

enum DeliveryStatus {
  EMPTY                    // ç©º
  IN_TRANSIT_UNACTIVATED  // åœ¨é€”æœªæ¿€æ´»
  IN_TRANSIT_ACTIVATED    // åœ¨é€”å·²æ¿€æ´»
  RECEIVED_UNACTIVATED    // å·²æ”¶åˆ°æœªæ¿€æ´»
}

enum Role {
  ADMIN     // ç®¡ç†å‘˜
  MARKETER  // è¥é”€äººå‘˜
}
```

  

### 2.2 APIæ¥å£è®¾è®¡

  

#### 2.2.1 å·ç ç®¡ç† API

  

**GET /api/numbers**

- åŠŸèƒ½ï¼šè·å–å·ç åˆ—è¡¨
    
- å‚æ•°ï¼š
    
    - `page`: é¡µç 
        
    - `hideReserved`: æ˜¯å¦éšè—å·²é¢„å®šå·ç 
        
- è¿”å›ï¼šå·ç åˆ—è¡¨æ•°æ®
    
      
    

```TypeScript
// å®ç°ç¤ºä¾‹
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get('page') || '1', 10);
  const hideReserved = searchParams.get('hideReserved') === 'true';
  
  const where = hideReserved ? 
    { reservationStatus: 'UNRESERVED' } : {};
  
  const phoneNumbers = await prisma.phoneNumber.findMany({
    where,
    orderBy: [
      { isPremium: 'desc' },
      { phoneNumber: 'asc' }
    ],
    skip: (page - 1) * 100,
    take: 100
  });
  
  return NextResponse.json(phoneNumbers);
}
```

  

#### 2.2.2 è®¢å•ç®¡ç† API

  

**POST /api/orders**

- åŠŸèƒ½ï¼šåˆ›å»ºæ–°è®¢å•
    
- å‚æ•°ï¼šå·ç IDã€å®¢æˆ·ä¿¡æ¯ã€æ”¯ä»˜é‡‘é¢ç­‰
    
- ç‰¹è‰²ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿å¹¶å‘å®‰å…¨
    
      
    

```TypeScript
export async function POST(request: Request) {
  const body = await request.json();
  
  // ä½¿ç”¨äº‹åŠ¡é˜²æ­¢å¹¶å‘é—®é¢˜
  const updatedNumber = await prisma.$transaction(async (tx) => {
    const numberToReserve = await tx.phoneNumber.findUnique({
      where: { id: body.numberId }
    });
    
    if (numberToReserve?.reservationStatus !== 'UNRESERVED') {
      throw new Error('è¯¥å·ç å·²è¢«é¢„å®šæˆ–æ­£åœ¨å®¡æ ¸ä¸­');
    }
    
    return tx.phoneNumber.update({
      where: { id: body.numberId },
      data: {
        reservationStatus: 'PENDING_REVIEW',
        orderTimestamp: new Date(),
        customerName: body.customerName,
        customerContact: body.customerContact,
        shippingAddress: body.shippingAddress,
        paymentAmount: parseFloat(body.paymentAmount)
      }
    });
  });
  
  return NextResponse.json(updatedNumber);
}
```

  

### 2.3 èº«ä»½è®¤è¯ç³»ç»Ÿ

  

#### 2.3.1 NextAuth.js é…ç½®

  

<mcfile name="auth.ts" path="src/lib/auth.ts"></mcfile>

  

```TypeScript
import { NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import bcrypt from 'bcryptjs';
import prisma from './prisma';

export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }
        
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        });
        
        if (!user || !user.password) {
          return null;
        }
        
        const isPasswordValid = await bcrypt.compare(
          credentials.password, 
          user.password
        );
        
        if (!isPasswordValid) {
          return null;
        }
        
        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        };
      }
    })
  ],
  session: {
    strategy: 'jwt'
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.id = token.sub!;
        session.user.role = token.role as string;
      }
      return session;
    }
  }
};
```

  

#### 2.3.2 æƒé™æ§åˆ¶ä¸­é—´ä»¶

  

```TypeScript
// æƒé™æ£€æŸ¥å‡½æ•°
export async function checkAdminPermission(request: NextRequest) {
  const session = await getServerSession(authOptions);
  
  if (!session || session.user.role !== 'ADMIN') {
    return new NextResponse('Unauthorized', { status: 401 });
  }
  
  return null;
}
```

  

## 3. å‰ç«¯ç»„ä»¶æ¶æ„

  

### 3.1 å®¢æˆ·ç«¯ç»„ä»¶

  

#### 3.1.1 å·ç å¡ç‰‡ç»„ä»¶

  

<mcfile name="NumberCard.tsx" path="src/components/ui/NumberCard.tsx"></mcfile>

  

```TypeScript
interface NumberCardProps {
  number: PhoneNumber;
  onSelect: (number: PhoneNumber) => void;
  isSelectable: boolean;
}

export const NumberCard = ({ number, onSelect, isSelectable }: NumberCardProps) => {
  const handleCopy = async (phoneNumber: string) => {
    try {
      await navigator.clipboard.writeText(phoneNumber);
      // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥:', err);
    }
  };
  
  return (
    <div className={`
      relative p-4 border rounded-lg transition-all duration-200
      ${isSelectable ? 'hover:shadow-md cursor-pointer' : 'opacity-50'}
      ${number.isPremium ? 'border-red-300 bg-red-50' : 'border-gray-200'}
    `}>
      {number.isPremium && (
        <div className="absolute -top-2 -right-2">
          <span className="text-red-500">ğŸ‘‘</span>
        </div>
      )}
      
      <div className="text-lg font-mono font-bold">
        {number.phoneNumber}
      </div>
      
      {number.isPremium && (
        <div className="text-xs text-red-600 mt-1">
          {number.premiumReason}
        </div>
      )}
      
      <div className="flex justify-between items-center mt-2">
        <button
          onClick={() => handleCopy(number.phoneNumber)}
          className="text-xs text-gray-500 hover:text-gray-700"
        >
          ğŸ“‹ å¤åˆ¶
        </button>
        
        {isSelectable && (
          <button
            onClick={() => onSelect(number)}
            className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
          >
            é€‰æ‹©
          </button>
        )}
      </div>
    </div>
  );
};
```

  

#### 3.1.2 è®¢å•æ¨¡æ€æ¡†ç»„ä»¶

  

<mcfile name="OrderModal.tsx" path="src/components/ui/OrderModal.tsx"></mcfile>

  

```TypeScript
interface OrderModalProps {
  number: PhoneNumber | null;
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (orderData: OrderData) => void;
}

export const OrderModal = ({ number, isOpen, onClose, onSubmit }: OrderModalProps) => {
  const [formData, setFormData] = useState({
    customerName: '',
    customerContact: '',
    shippingAddress: '',
    paymentAmount: 20
  });
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // è¡¨å•éªŒè¯
    if (!formData.customerName || !formData.customerContact) {
      alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
      return;
    }
    
    if (formData.paymentAmount === 200 && !formData.shippingAddress) {
      alert('é€‰æ‹©200å…ƒå…¨æ¬¾æ—¶å¿…é¡»å¡«å†™æ”¶è´§åœ°å€');
      return;
    }
    
    onSubmit({
      numberId: number!.id,
      ...formData
    });
  };
  
  if (!isOpen || !number) return null;
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <h2 className="text-xl font-bold mb-4">é¢„å®šå·ç </h2>
        
        <div className="mb-4 p-3 bg-blue-50 rounded">
          <div className="text-lg font-mono font-bold text-blue-800">
            {number.phoneNumber}
          </div>
          {number.isPremium && (
            <div className="text-sm text-red-600">
              ğŸ‘‘ {number.premiumReason}
            </div>
          )}
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          {/* æ”¯ä»˜æ–¹å¼é€‰æ‹© */}
          <div>
            <label className="block text-sm font-medium mb-2">æ”¯ä»˜æ–¹å¼</label>
            <div className="space-y-2">
              <label className="flex items-center">
                <input
                  type="radio"
                  name="paymentAmount"
                  value={20}
                  checked={formData.paymentAmount === 20}
                  onChange={(e) => setFormData({...formData, paymentAmount: 20})}
                  className="mr-2"
                />
                <span>20å…ƒå®šé‡‘ï¼ˆåˆ°æ ¡åè¡¥é½180å…ƒï¼‰</span>
              </label>
              <label className="flex items-center">
                <input
                  type="radio"
                  name="paymentAmount"
                  value={200}
                  checked={formData.paymentAmount === 200}
                  onChange={(e) => setFormData({...formData, paymentAmount: 200})}
                  className="mr-2"
                />
                <span>200å…ƒå…¨æ¬¾ï¼ˆåŒ…é‚®åˆ°å®¿èˆï¼‰</span>
              </label>
            </div>
          </div>
          
          {/* å®¢æˆ·ä¿¡æ¯è¡¨å• */}
          <div>
            <label className="block text-sm font-medium mb-1">å§“å *</label>
            <input
              type="text"
              value={formData.customerName}
              onChange={(e) => setFormData({...formData, customerName: e.target.value})}
              className="w-full p-2 border rounded"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">è”ç³»ç”µè¯ *</label>
            <input
              type="tel"
              value={formData.customerContact}
              onChange={(e) => setFormData({...formData, customerContact: e.target.value})}
              className="w-full p-2 border rounded"
              required
            />
          </div>
          
          {formData.paymentAmount === 200 && (
            <div>
              <label className="block text-sm font-medium mb-1">æ”¶è´§åœ°å€ *</label>
              <textarea
                value={formData.shippingAddress}
                onChange={(e) => setFormData({...formData, shippingAddress: e.target.value})}
                className="w-full p-2 border rounded h-20"
                placeholder="è¯·å¡«å†™è¯¦ç»†çš„æ”¶è´§åœ°å€"
                required
              />
            </div>
          )}
          
          <div className="flex space-x-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-2 border border-gray-300 rounded hover:bg-gray-50"
            >
              å–æ¶ˆ
            </button>
            <button
              type="submit"
              className="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              æäº¤è®¢å•
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
```

  

### 3.2 ç®¡ç†åå°ç»„ä»¶

  

#### 3.2.1 æ•°æ®ç»Ÿè®¡å¡ç‰‡

  

<mcfile name="StatsCards.tsx" path="src/components/admin/StatsCards.tsx"></mcfile>

  

```TypeScript
interface StatsCardsProps {
  totalNumbers: number;
  availableNumbers: number;
  pendingOrders: number;
  todayOrders: number;
}

export const StatsCards = ({ 
  totalNumbers, 
  availableNumbers, 
  pendingOrders, 
  todayOrders 
}: StatsCardsProps) => {
  const stats = [
    {
      title: 'æ€»å·ç æ•°',
      value: totalNumbers,
      icon: 'ğŸ“±',
      color: 'bg-blue-500'
    },
    {
      title: 'å‰©ä½™å¯é€‰',
      value: availableNumbers,
      icon: 'âœ…',
      color: 'bg-green-500'
    },
    {
      title: 'å¾…å®¡æ ¸è®¢å•',
      value: pendingOrders,
      icon: 'â³',
      color: 'bg-yellow-500'
    },
    {
      title: 'ä»Šæ—¥æ–°å¢è®¢å•',
      value: todayOrders,
      icon: 'ğŸ“ˆ',
      color: 'bg-purple-500'
    }
  ];
  
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      {stats.map((stat, index) => (
        <div key={index} className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className={`${stat.color} rounded-full p-3 text-white text-2xl mr-4`}>
              {stat.icon}
            </div>
            <div>
              <p className="text-sm font-medium text-gray-600">{stat.title}</p>
              <p className="text-2xl font-bold text-gray-900">{stat.value}</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};
```

  

#### 3.2.2 å¾…å®¡æ ¸è®¢å•è¡¨æ ¼

  

<mcfile name="PendingOrdersTable.tsx" path="src/components/admin/PendingOrdersTable.tsx"></mcfile>

  

```TypeScript
interface PendingOrdersTableProps {
  initialPendingNumbers: PhoneNumber[];
  onApprove: (number: PhoneNumber) => void;
  onRelease: (numberId: string) => void;
}

export const PendingOrdersTable = ({ 
  initialPendingNumbers, 
  onApprove, 
  onRelease 
}: PendingOrdersTableProps) => {
  const [pendingNumbers, setPendingNumbers] = useState(initialPendingNumbers);
  
  // è®¡ç®—å€’è®¡æ—¶
  const formatTimeLeft = (timestamp: string | Date): string => {
    const orderTime = new Date(timestamp).getTime();
    const now = new Date().getTime();
    const diffMinutes = Math.floor((now - orderTime) / (1000 * 60));
    
    if (diffMinutes >= 30) {
      return "å·²è¶…æ—¶";
    }
    
    const timeLeft = 30 - diffMinutes;
    return `${timeLeft} åˆ†é’Ÿåè¶…æ—¶`;
  };
  
  const handleRelease = async (numberId: string) => {
    if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨é‡Šæ”¾è¿™ä¸ªå·ç å—ï¼Ÿ')) return;
    onRelease(numberId);
  };
  
  return (
    <div className="mb-8">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold">å¾…å®¡æ ¸è®¢å•</h2>
        <div className="text-sm text-gray-600">
          å…± {pendingNumbers.length} ä¸ªå¾…å®¡æ ¸è®¢å•
        </div>
      </div>
      
      {pendingNumbers.length === 0 ? (
        <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
          æš‚æ— å¾…å®¡æ ¸è®¢å•
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  å·ç 
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  å®¢æˆ·ä¿¡æ¯
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  æ”¯ä»˜é‡‘é¢
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ä¸‹å•æ—¶é—´
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {pendingNumbers.map((number) => {
                const isOvertime = number.orderTimestamp && 
                  (new Date().getTime() - new Date(number.orderTimestamp).getTime()) > 30 * 60 * 1000;
                
                return (
                  <tr key={number.id} className={isOvertime ? 'bg-red-50' : ''}>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <span className="font-mono font-bold">{number.phoneNumber}</span>
                        {number.isPremium && (
                          <span className="ml-2 text-red-500">ğŸ‘‘</span>
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="font-medium">{number.customerName}</div>
                        <div className="text-sm text-gray-500">{number.customerContact}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className="font-bold text-green-600">
                        Â¥{number.paymentAmount}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="text-sm">
                          {number.orderTimestamp && 
                            new Date(number.orderTimestamp).toLocaleString()}
                        </div>
                        <div className={`text-xs ${
                          isOvertime ? 'text-red-600 font-bold' : 'text-gray-500'
                        }`}>
                          {number.orderTimestamp && formatTimeLeft(number.orderTimestamp)}
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                      <button
                        onClick={() => onApprove(number)}
                        className="text-green-600 hover:text-green-900"
                      >
                        æ‰¹å‡†
                      </button>
                      <button
                        onClick={() => handleRelease(number.id)}
                        className="text-red-600 hover:text-red-900"
                      >
                        é‡Šæ”¾
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};
```

  

## 4. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

  

### 4.1 å¹¶å‘å®‰å…¨æœºåˆ¶

  

#### 4.1.1 æ•°æ®åº“äº‹åŠ¡

  

```TypeScript
// é˜²æ­¢å·ç é‡å¤é¢„å®šçš„äº‹åŠ¡å¤„ç†
const reserveNumber = async (numberId: string, orderData: OrderData) => {
  return await prisma.$transaction(async (tx) => {
    // 1. æ£€æŸ¥å·ç çŠ¶æ€
    const number = await tx.phoneNumber.findUnique({
      where: { id: numberId }
    });
    
    if (!number || number.reservationStatus !== 'UNRESERVED') {
      throw new Error('å·ç ä¸å¯ç”¨');
    }
    
    // 2. æ›´æ–°å·ç çŠ¶æ€
    return await tx.phoneNumber.update({
      where: { id: numberId },
      data: {
        reservationStatus: 'PENDING_REVIEW',
        orderTimestamp: new Date(),
        ...orderData
      }
    });
  });
};
```

  

### 4.2 é“å·è‡ªåŠ¨è¯†åˆ«

  

```TypeScript
// é“å·è¯†åˆ«ç®—æ³•
const analyzePremiumNumber = (phoneNumber: string): {
  isPremium: boolean;
  reason?: string;
} => {
  const number = phoneNumber.slice(-8); // å–å8ä½
  
  // è¿å·æ£€æµ‹
  const hasConsecutive = /012|123|234|345|456|567|678|789|987|876|765|654|543|432|321|210/.test(number);
  if (hasConsecutive) {
    return { isPremium: true, reason: 'è¿å·' };
  }
  
  // é‡å¤å·ç æ£€æµ‹
  const hasRepeating = /([0-9])\1{2,}/.test(number);
  if (hasRepeating) {
    return { isPremium: true, reason: 'é‡å¤å·ç ' };
  }
  
  // å¯¹ç§°å·ç æ£€æµ‹
  const isSymmetric = number === number.split('').reverse().join('');
  if (isSymmetric) {
    return { isPremium: true, reason: 'å¯¹ç§°å·ç ' };
  }
  
  // ç‰¹æ®Šå·ç æ£€æµ‹
  const specialPatterns = [
    { pattern: /8888|6666|9999/, reason: 'å‰ç¥¥å·ç ' },
    { pattern: /1314|520|1688/, reason: 'å¯“æ„å·ç ' }
  ];
  
  for (const { pattern, reason } of specialPatterns) {
    if (pattern.test(number)) {
      return { isPremium: true, reason };
    }
  }
  
  return { isPremium: false };
};
```

  

### 4.3 æ•°æ®å¯¼å…¥å¤„ç†

  

```TypeScript
// æ‰¹é‡æ•°æ®å¯¼å…¥é€»è¾‘
const importPhoneNumbers = async (data: any[], fieldMapping: FieldMapping) => {
  const results = [];
  
  for (const row of data) {
    try {
      const phoneNumber = row[fieldMapping.phoneNumber];
      
      if (!phoneNumber) {
        results.push({ success: false, error: 'å·ç ä¸èƒ½ä¸ºç©º' });
        continue;
      }
      
      // é“å·åˆ†æ
      const premiumAnalysis = analyzePremiumNumber(phoneNumber);
      
      // å‡†å¤‡æ•°æ®
      const numberData = {
        phoneNumber,
        isPremium: premiumAnalysis.isPremium,
        premiumReason: premiumAnalysis.reason,
        customerName: row[fieldMapping.customerName] || null,
        assignedMarketer: row[fieldMapping.assignedMarketer] || null,
        // ... å…¶ä»–å­—æ®µæ˜ å°„
      };
      
      // ä½¿ç”¨ upsert è¿›è¡Œæ’å…¥æˆ–æ›´æ–°
      await prisma.phoneNumber.upsert({
        where: { phoneNumber },
        update: numberData,
        create: numberData
      });
      
      results.push({ success: true, phoneNumber });
    } catch (error) {
      results.push({ 
        success: false, 
        phoneNumber: row[fieldMapping.phoneNumber],
        error: error.message 
      });
    }
  }
  
  return results;
};
```

  

## 5. éƒ¨ç½²ä¸è¿ç»´

  

### 5.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

  

#### 5.1.1 ç¯å¢ƒå˜é‡

  

```Bash
# .env æ–‡ä»¶
DATABASE_URL="file:./prisma/dev.db"
NEXTAUTH_URL="https://domain.com"
NEXTAUTH_SECRET="your-secret-key"
NODE_ENV="production"
PORT=3000
```

  

#### 5.1.2 éƒ¨ç½²è„šæœ¬

  

<mcfile name="deploy.bat" path="deploy.bat"></mcfile>

  

```Bash
@echo off
echo æ­£åœ¨é…ç½®ç”Ÿäº§ç¯å¢ƒ...

:: è®¾ç½®ç¯å¢ƒå˜é‡
echo DATABASE_URL="file:./prisma/dev.db" > .env.local
echo NEXTAUTH_URL="https://domain.com" >> .env.local
echo NEXTAUTH_SECRET="your-nextauth-secret-key" >> .env.local
echo NODE_ENV="production" >> .env.local
echo PORT=3000 >> .env.local

:: å®‰è£…ä¾èµ–
npm install --production

:: ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate

:: è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma db push

:: æ„å»ºåº”ç”¨
npm run build

echo éƒ¨ç½²å®Œæˆï¼
echo è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š
echo pm2 start server.js --name telecom-app
pause
```

  

### 5.2 PM2 é…ç½®

  

#### 5.2.1 ç”Ÿæ€ç³»ç»Ÿé…ç½®

  

```TypeScript
module.exports = {
  apps: [{
    name: 'telecom-app',
    script: 'server.js',
    cwd: '/www/wwwroot/telecom',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
      DATABASE_URL: 'file:./prisma/dev.db',
      NEXTAUTH_URL: 'https://domain.com',
      NEXTAUTH_SECRET: 'your-secret-key'
    },
    instances: 1,
    exec_mode: 'fork',
    watch: false,
    max_memory_restart: '1G',
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

  

#### 5.2.2 å¸¸ç”¨å‘½ä»¤

  

```Bash
# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs telecom-app

# é‡å¯åº”ç”¨
pm2 restart telecom-app

# åœæ­¢åº”ç”¨
pm2 stop telecom-app

# åˆ é™¤åº”ç”¨
pm2 delete telecom-app
```

  

### 5.3 æ•°æ®åº“ç»´æŠ¤

  

#### 5.3.1 å¤‡ä»½è„šæœ¬

  

```Bash
#!/bin/bash
# backup.sh

DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/backup/telecom"
DB_FILE="/www/wwwroot/telecom/prisma/dev.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤åˆ¶æ•°æ®åº“æ–‡ä»¶
cp $DB_FILE $BACKUP_DIR/dev_$DATE.db

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/dev_$DATE.db

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: dev_$DATE.db.gz"
```

  

#### 5.3.2 æ•°æ®åº“è¿ç§»

  

```Bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name add_new_field

# åº”ç”¨è¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒ
npx prisma migrate deploy

# é‡ç½®æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npx prisma migrate reset

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npx prisma migrate status
```

  

## 6. æ€§èƒ½ä¼˜åŒ–

  

### 6.1 å‰ç«¯ä¼˜åŒ–

  

#### 6.1.1 æ— é™æ»šåŠ¨å®ç°

  

```TypeScript
// ä½¿ç”¨ Intersection Observer å®ç°æ— é™æ»šåŠ¨
const useInfiniteScroll = (callback: () => void) => {
  const [isFetching, setIsFetching] = useState(false);
  const loaderRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !isFetching) {
          setIsFetching(true);
          callback();
        }
      },
      { threshold: 0.1 }
    );
    
    if (loaderRef.current) {
      observer.observe(loaderRef.current);
    }
    
    return () => observer.disconnect();
  }, [callback, isFetching]);
  
  return { loaderRef, isFetching, setIsFetching };
};
```

  

#### 6.1.2 ç»„ä»¶æ‡’åŠ è½½

  

```TypeScript
// åŠ¨æ€å¯¼å…¥ç»„ä»¶
const ExportModal = dynamic(() => import('@/components/admin/ExportModal'), {
  loading: () => <div>åŠ è½½ä¸­...</div>,
  ssr: false
});

const ImportPage = dynamic(() => import('@/app/admin/import/page'), {
  loading: () => <div>åŠ è½½ä¸­...</div>
});
```

  

### 6.2 åç«¯ä¼˜åŒ–

  

#### 6.2.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

  

```TypeScript
// ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
const getNumbersWithPagination = async (page: number, hideReserved: boolean) => {
  const where = hideReserved ? { reservationStatus: 'UNRESERVED' } : {};
  
  return await prisma.phoneNumber.findMany({
    where,
    select: {
      id: true,
      phoneNumber: true,
      isPremium: true,
      premiumReason: true,
      reservationStatus: true
    }, // åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
    orderBy: [
      { isPremium: 'desc' },
      { phoneNumber: 'asc' }
    ],
    skip: (page - 1) * 100,
    take: 100
  });
};
```

  

#### 6.2.2 ç¼“å­˜ç­–ç•¥

  

```TypeScript
// ä½¿ç”¨ Next.js ç¼“å­˜
export async function GET(request: NextRequest) {
  const response = NextResponse.json(data);
  
  // è®¾ç½®ç¼“å­˜å¤´
  response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=300');
  
  return response;
}
```

  

## 7. å®‰å…¨æ€§è€ƒè™‘

  

### 7.1 è¾“å…¥éªŒè¯

  

```TypeScript
// ä½¿ç”¨ Zod è¿›è¡Œè¾“å…¥éªŒè¯
import { z } from 'zod';

const OrderSchema = z.object({
  numberId: z.string().cuid(),
  customerName: z.string().min(1).max(50),
  customerContact: z.string().regex(/^1[3-9]\d{9}$/),
  paymentAmount: z.number().positive(),
  shippingAddress: z.string().optional()
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const validatedData = OrderSchema.parse(body);
    
    // å¤„ç†éªŒè¯åçš„æ•°æ®
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse('è¾“å…¥æ•°æ®æ— æ•ˆ', { status: 400 });
    }
  }
}
```

  

### 7.2 æƒé™æ§åˆ¶

  

```TypeScript
// API è·¯ç”±æƒé™ä¸­é—´ä»¶
const withAuth = (handler: Function, requiredRole?: Role) => {
  return async (request: NextRequest) => {
    const session = await getServerSession(authOptions);
    
    if (!session) {
      return new NextResponse('æœªæˆæƒ', { status: 401 });
    }
    
    if (requiredRole && session.user.role !== requiredRole) {
      return new NextResponse('æƒé™ä¸è¶³', { status: 403 });
    }
    
    return handler(request);
  };
};

// ä½¿ç”¨ç¤ºä¾‹
export const DELETE = withAuth(async (request: NextRequest) => {
  // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤
}, 'ADMIN');
```

  

## 8. æµ‹è¯•ç­–ç•¥

  

### 8.1 å•å…ƒæµ‹è¯•

  

```TypeScript
// __tests__/utils.test.ts
import { analyzePremiumNumber } from '@/lib/utils';

describe('analyzePremiumNumber', () => {
  test('åº”è¯¥è¯†åˆ«è¿å·', () => {
    const result = analyzePremiumNumber('18812345678');
    expect(result.isPremium).toBe(true);
    expect(result.reason).toBe('è¿å·');
  });
  
  test('åº”è¯¥è¯†åˆ«é‡å¤å·ç ', () => {
    const result = analyzePremiumNumber('18888888888');
    expect(result.isPremium).toBe(true);
    expect(result.reason).toBe('é‡å¤å·ç ');
  });
  
  test('æ™®é€šå·ç ä¸åº”è¯¥è¢«æ ‡è®°ä¸ºé“å·', () => {
    const result = analyzePremiumNumber('18812349876');
    expect(result.isPremium).toBe(false);
  });
});
```

  

### 8.2 é›†æˆæµ‹è¯•

  

```TypeScript
// __tests__/api/orders.test.ts
import { POST } from '@/app/api/orders/route';
import { NextRequest } from 'next/server';

describe('/api/orders', () => {
  test('åº”è¯¥æˆåŠŸåˆ›å»ºè®¢å•', async () => {
    const request = new NextRequest('http://localhost:3000/api/orders', {
      method: 'POST',
      body: JSON.stringify({
        numberId: 'test-id',
        customerName: 'æµ‹è¯•ç”¨æˆ·',
        customerContact: '13800138000',
        paymentAmount: 20
      })
    });
    
    const response = await POST(request);
    expect(response.status).toBe(201);
  });
  
  test('åº”è¯¥æ‹’ç»æ— æ•ˆè¾“å…¥', async () => {
    const request = new NextRequest('http://localhost:3000/api/orders', {
      method: 'POST',
      body: JSON.stringify({
        numberId: 'test-id'
        // ç¼ºå°‘å¿…è¦å­—æ®µ
      })
    });
    
    const response = await POST(request);
    expect(response.status).toBe(400);
  });
});
```

  

## 9. ç›‘æ§ä¸æ—¥å¿—

  

### 9.1 é”™è¯¯ç›‘æ§

  

```TypeScript
// lib/logger.ts
export const logger = {
  error: (message: string, error?: Error, context?: any) => {
    console.error(`[ERROR] ${message}`, {
      error: error?.message,
      stack: error?.stack,
      context,
      timestamp: new Date().toISOString()
    });
  },
  
  info: (message: string, context?: any) => {
    console.log(`[INFO] ${message}`, {
      context,
      timestamp: new Date().toISOString()
    });
  },
  
  warn: (message: string, context?: any) => {
    console.warn(`[WARN] ${message}`, {
      context,
      timestamp: new Date().toISOString()
    });
  }
};
```

  

### 9.2 æ€§èƒ½ç›‘æ§

  

```TypeScript
// æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
const performanceMiddleware = (handler: Function) => {
  return async (request: NextRequest) => {
    const start = Date.now();
    
    try {
      const response = await handler(request);
      const duration = Date.now() - start;
      
      logger.info('APIè¯·æ±‚å®Œæˆ', {
        method: request.method,
        url: request.url,
        duration,
        status: response.status
      });
      
      return response;
    } catch (error) {
      const duration = Date.now() - start;
      
      logger.error('APIè¯·æ±‚å¤±è´¥', error as Error, {
        method: request.method,
        url: request.url,
        duration
      });
      
      throw error;
    }
  };
};
```

  

## 10. æ•…éšœæ’é™¤æŒ‡å—

  

### 10.1 å¸¸è§é—®é¢˜

  

#### 10.1.1 æ•°æ®åº“è¿æ¥é—®é¢˜

  

```Bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la prisma/dev.db

# ä¿®å¤æƒé™
chmod 644 prisma/dev.db
chown www-data:www-data prisma/dev.db

# é‡æ–°ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate
```

  

#### 10.1.2 ç¯å¢ƒå˜é‡é—®é¢˜

  

```Bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 env telecom-app | grep -E "DATABASE_URL|NEXTAUTH_URL"

# è®¾ç½®ç¯å¢ƒå˜é‡
pm2 set telecom-app:DATABASE_URL "file:./prisma/dev.db"
pm2 set telecom-app:NEXTAUTH_URL "https://xh.nfeyre.top"

# é‡å¯åº”ç”¨
pm2 restart telecom-app
```

  

#### 10.1.3 æ„å»ºé—®é¢˜

  

```Bash
# æ¸…ç†ç¼“å­˜
rm -rf .next
npm run build

# æ£€æŸ¥ä¾èµ–
npm audit
npm audit fix
```

  

### 10.2 æ—¥å¿—åˆ†æ

  

```Bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs telecom-app --lines 100

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs telecom-app --err --lines 50

# å®æ—¶ç›‘æ§æ—¥å¿—
pm2 logs telecom-app --follow
```

  

---

  

**æ–‡æ¡£ç»´æŠ¤ï¼š** è¯·åœ¨æ¯æ¬¡é‡å¤§æ›´æ–°ååŠæ—¶æ›´æ–°æ­¤å¼€å‘æ–‡æ¡£

**æŠ€æœ¯æ”¯æŒï¼š** å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’é™¤æŒ‡å—æˆ–è”ç³»å¼€å‘å›¢é˜Ÿ

**ç‰ˆæœ¬æ§åˆ¶ï¼š** ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ