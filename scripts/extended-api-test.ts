import axios, { AxiosInstance } from 'axios';
import { wrapper } from 'axios-cookiejar-support';
import { CookieJar } from 'tough-cookie';
import * as fs from 'fs';
import * as path from 'path';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

interface ExtendedTestUser {
  email: string;
  password: string;
  role: string;
  name: string;
  description: string;
  school?: string;
  department?: string;
}

interface TestResult {
  testName: string;
  success: boolean;
  details?: string;
  errorMessage?: string;
  timestamp: Date;
  responseTime?: number;
  statusCode?: number;
  responseData?: any;
}

interface ExtendedTestReport {
  summary: {
    total: number;
    passed: number;
    failed: number;
    duration: number;
    timestamp: string;
    testCategories: Record<string, { passed: number; total: number }>;
  };
  testResults: TestResult[];
  failedTests: TestResult[];
  userTests: Record<string, TestResult[]>;
  apiCoverage: {
    totalEndpoints: number;
    testedEndpoints: number;
    coverage: number;
    endpointDetails: Record<string, { tested: boolean; methods: string[] }>;
  };
  performanceMetrics: {
    averageResponseTime: number;
    slowestEndpoint: { endpoint: string; time: number };
    fastestEndpoint: { endpoint: string; time: number };
  };
}

class ExtendedAPITester {
  private baseUrl: string;
  private testResults: TestResult[] = [];
  private authenticatedClients: Map<string, AxiosInstance> = new Map();
  private startTime: Date;
  private extendedTestUsers: ExtendedTestUser[];
  private testedEndpoints: Set<string> = new Set();

  constructor(baseUrl: string = 'http://localhost:3000') {
    this.baseUrl = baseUrl;
    this.startTime = new Date();
    
    // Êâ©Â±ïÁöÑÊµãËØïÁî®Êà∑ÂàóË°®
    this.extendedTestUsers = [
      {
        email: 'admin@system.com',
        password: '123456',
        role: 'SUPER_ADMIN',
        name: 'Á≥ªÁªüÁÆ°ÁêÜÂëò',
        description: 'Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºåÊã•ÊúâÊâÄÊúâÊùÉÈôê'
      },
      {
        email: 'admin@pku.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: 'ÂåóÂ§ßÁÆ°ÁêÜÂëò',
        description: 'Âåó‰∫¨Â§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: 'Âåó‰∫¨Â§ßÂ≠¶'
      },
      {
        email: 'admin@tsinghua.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: 'Ê∏ÖÂçéÁÆ°ÁêÜÂëò',
        description: 'Ê∏ÖÂçéÂ§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: 'Ê∏ÖÂçéÂ§ßÂ≠¶'
      },
      {
        email: 'admin@ruc.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: '‰∫∫Â§ßÁÆ°ÁêÜÂëò',
        description: '‰∏≠ÂõΩ‰∫∫Ê∞ëÂ§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: '‰∏≠ÂõΩ‰∫∫Ê∞ëÂ§ßÂ≠¶'
      },
      {
        email: 'admin@bnu.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: 'Â∏àÂ§ßÁÆ°ÁêÜÂëò',
        description: 'Âåó‰∫¨Â∏àËåÉÂ§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: 'Âåó‰∫¨Â∏àËåÉÂ§ßÂ≠¶'
      },
      {
        email: 'admin@bit.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: 'ÁêÜÂ∑•ÁÆ°ÁêÜÂëò',
        description: 'Âåó‰∫¨ÁêÜÂ∑•Â§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: 'Âåó‰∫¨ÁêÜÂ∑•Â§ßÂ≠¶'
      },
      {
        email: 'admin@buaa.edu.cn',
        password: '123456',
        role: 'SCHOOL_ADMIN',
        name: 'Ëà™Â§©ÁÆ°ÁêÜÂëò',
        description: 'Âåó‰∫¨Ëà™Á©∫Ëà™Â§©Â§ßÂ≠¶Ê†°Á∫ßÁÆ°ÁêÜÂëò',
        school: 'Âåó‰∫¨Ëà™Á©∫Ëà™Â§©Â§ßÂ≠¶'
      },
      {
        email: 'marketer1@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòÂº†‰∏â',
        description: 'Âåó‰∫¨Â§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: 'Âåó‰∫¨Â§ßÂ≠¶',
        department: 'ËÆ°ÁÆóÊú∫Â≠¶Èô¢'
      },
      {
        email: 'marketer2@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòÊùéÂõõ',
        description: 'Ê∏ÖÂçéÂ§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: 'Ê∏ÖÂçéÂ§ßÂ≠¶',
        department: 'ËΩØ‰ª∂Â≠¶Èô¢'
      },
      {
        email: 'marketer3@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòÁéã‰∫î',
        description: '‰∏≠ÂõΩ‰∫∫Ê∞ëÂ§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: '‰∏≠ÂõΩ‰∫∫Ê∞ëÂ§ßÂ≠¶',
        department: '‰ø°ÊÅØÂ≠¶Èô¢'
      },
      {
        email: 'marketer4@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòËµµÂÖ≠',
        description: 'Âåó‰∫¨Â∏àËåÉÂ§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: 'Âåó‰∫¨Â∏àËåÉÂ§ßÂ≠¶',
        department: 'ÂøÉÁêÜÂ≠¶Èô¢'
      },
      {
        email: 'marketer5@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòÈí±‰∏É',
        description: 'Âåó‰∫¨ÁêÜÂ∑•Â§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: 'Âåó‰∫¨ÁêÜÂ∑•Â§ßÂ≠¶',
        department: 'Êú∫Ê¢∞Â∑•Á®ãÂ≠¶Èô¢'
      },
      {
        email: 'marketer6@telecom.com',
        password: '123456',
        role: 'MARKETER',
        name: 'ÈîÄÂîÆÂëòÂ≠ôÂÖ´',
        description: 'Âåó‰∫¨Ëà™Á©∫Ëà™Â§©Â§ßÂ≠¶ÈîÄÂîÆ‰∫∫Âëò',
        school: 'Âåó‰∫¨Ëà™Á©∫Ëà™Â§©Â§ßÂ≠¶',
        department: 'Ëà™Á©∫Â≠¶Èô¢'
      }
    ];
  }

  private logResult(testName: string, success: boolean, details?: string, errorMessage?: string, responseTime?: number, statusCode?: number, responseData?: any) {
    const result: TestResult = {
      testName,
      success,
      details,
      errorMessage,
      timestamp: new Date(),
      responseTime,
      statusCode,
      responseData
    };
    
    this.testResults.push(result);
    
    const status = success ? '‚úÖ' : '‚ùå';
    const timeInfo = responseTime ? ` (${responseTime}ms)` : '';
    const statusInfo = statusCode ? ` [${statusCode}]` : '';
    
    console.log(`${status} ${testName}${timeInfo}${statusInfo}`);
    if (details) console.log(`   üìù ${details}`);
    if (errorMessage) console.log(`   ‚ö†Ô∏è  ${errorMessage}`);
  }

  private async resetDatabase() {
    console.log('üîÑ ÈáçÁΩÆÊï∞ÊçÆÂ∫ìÂπ∂ÂàõÂª∫Êâ©Â±ïÊµãËØïÊï∞ÊçÆ...');
    try {
      // ÈáçÁΩÆÊï∞ÊçÆÂ∫ì
      await execAsync('npx prisma migrate reset --force', { cwd: process.cwd() });
      console.log('‚úÖ Êï∞ÊçÆÂ∫ìÈáçÁΩÆÂÆåÊàê');
      
      // ËøêË°åÊâ©Â±ïÁßçÂ≠êÊï∞ÊçÆ
      console.log('üå± ËøêË°åÊâ©Â±ïÁßçÂ≠êÊï∞ÊçÆ...');
      await execAsync('npx tsx scripts/extended-seed-data.ts', { cwd: process.cwd() });
      console.log('‚úÖ Êâ©Â±ïÁßçÂ≠êÊï∞ÊçÆÂàõÂª∫ÂÆåÊàê');
      
      // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥Á°Æ‰øùÊï∞ÊçÆÂ∫ìÊìç‰ΩúÂÆåÊàê
      await new Promise(resolve => setTimeout(resolve, 2000));
      
    } catch (error: any) {
      console.error('‚ùå Êï∞ÊçÆÂ∫ìÈáçÁΩÆÂ§±Ë¥•:', error.message);
      throw error;
    }
  }

  private async createAuthenticatedClient(user: ExtendedTestUser): Promise<AxiosInstance> {
    const jar = new CookieJar();
    const client = wrapper(axios.create({
      baseURL: this.baseUrl,
      jar,
      timeout: 15000,
      validateStatus: () => true
    }));
  
    try {
      // 1. Ëé∑Âèñ CSRF token
      const csrfResponse = await client.get('/api/auth/csrf');
      const csrfToken = csrfResponse.data.csrfToken;
      
      // 2. ‰ΩøÁî®Ê≠£Á°ÆÁöÑ NextAuth credentials provider ÁôªÂΩïÊñπÂºè
      const loginData = new URLSearchParams({
        email: user.email,
        password: user.password,
        csrfToken: csrfToken,
        callbackUrl: `${this.baseUrl}/admin/dashboard`,
        redirect: 'false',
        json: 'true'
      });
  
      const signinResponse = await client.post('/api/auth/callback/credentials', loginData, {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        maxRedirects: 0,
        validateStatus: (status) => status < 400 || status === 302
      });
  
      // 3. È™åËØÅ‰ºöËØùÊòØÂê¶Âª∫Á´ã
      const sessionResponse = await client.get('/api/auth/session');
      if (sessionResponse.status === 200 && sessionResponse.data?.user) {
        this.logResult(`Authentication - ${user.role} (${user.school || 'System'})`, true, `User ${user.email} authenticated successfully`);
        return client;
      }
      
      throw new Error(`Login failed - Status: ${signinResponse.status}`);
      
    } catch (error: any) {
      this.logResult(`Authentication - ${user.role} (${user.school || 'System'})`, false, undefined, `Failed to authenticate ${user.email}: ${error.message}`);
      throw error;
    }
  }

  private async testApiEndpoint(
    client: AxiosInstance | null,
    method: 'GET' | 'POST' | 'PUT' | 'DELETE',
    endpoint: string,
    testName: string,
    data?: any,
    expectedStatus?: number,
    category: string = 'General'
  ): Promise<{ success: boolean; data?: any; status?: number }> {
    const startTime = Date.now();
    this.testedEndpoints.add(`${method} ${endpoint}`);
    
    try {
      const axiosClient = client || axios.create({ baseURL: this.baseUrl, timeout: 15000 });
      
      let response;
      switch (method) {
        case 'GET':
          const params = data ? new URLSearchParams(data).toString() : '';
          const url = params ? `${endpoint}?${params}` : endpoint;
          response = await axiosClient.get(url);
          break;
        case 'POST':
          response = await axiosClient.post(endpoint, data);
          break;
        case 'PUT':
          response = await axiosClient.put(endpoint, data);
          break;
        case 'DELETE':
          response = await axiosClient.delete(endpoint);
          break;
      }
      
      const responseTime = Date.now() - startTime;
      const success = expectedStatus ? response.status === expectedStatus : response.status < 400;
      
      this.logResult(
        `[${category}] ${testName}`,
        success,
        success ? `${method} ${endpoint} - Response received` : undefined,
        !success ? `Expected status ${expectedStatus || 'success'}, got ${response.status}` : undefined,
        responseTime,
        response.status,
        response.data
      );
      
      return {
        success,
        data: response.data,
        status: response.status
      };
    } catch (error: any) {
      const responseTime = Date.now() - startTime;
      const status = error.response?.status;
      const success = expectedStatus ? status === expectedStatus : false;
      
      this.logResult(
        `[${category}] ${testName}`,
        success,
        success ? `Expected error status ${expectedStatus}` : undefined,
        !success ? `${method} ${endpoint} failed: ${error.message}` : undefined,
        responseTime,
        status
      );
      
      return {
        success,
        status
      };
    }
  }

  async runExtendedTests(): Promise<ExtendedTestReport> {
    console.log('üöÄ ÂºÄÂßãÊâ©Â±ïAPIÊµãËØï...');
    console.log(`üìç ÊµãËØïÁõÆÊ†á: ${this.baseUrl}`);
    console.log(`‚è∞ ÂºÄÂßãÊó∂Èó¥: ${this.startTime.toLocaleString()}`);
    console.log(`üë• ÊµãËØïÁî®Êà∑Êï∞Èáè: ${this.extendedTestUsers.length}`);
    
    try {
      // 0. Êï∞ÊçÆÈáçÁΩÆ
      console.log('\n=== 0. Êï∞ÊçÆÈáçÁΩÆ ===');
      await this.resetDatabase();
      
      // 1. ÊúçÂä°Âô®ËøûÊé•ÊµãËØï
      console.log('\n=== 1. ÊúçÂä°Âô®ËøûÊé•ÊµãËØï ===');
      await this.testApiEndpoint(null, 'GET', '/', 'Server Connectivity', undefined, undefined, 'Infrastructure');
      
      // 2. ÂÖ¨ÂÖ±APIÊµãËØï
      console.log('\n=== 2. ÂÖ¨ÂÖ±APIÊµãËØï ===');
      await this.testApiEndpoint(null, 'GET', '/api/numbers', 'Public - Phone Numbers List', undefined, undefined, 'Public API');
      await this.testApiEndpoint(null, 'GET', '/api/numbers?hideReserved=true', 'Public - Filtered Numbers (Hide Reserved)', undefined, undefined, 'Public API');
      await this.testApiEndpoint(null, 'GET', '/api/numbers?page=2', 'Public - Paginated Numbers', undefined, undefined, 'Public API');
      await this.testApiEndpoint(null, 'GET', '/api/auth/csrf', 'Auth - CSRF Token', undefined, undefined, 'Authentication');
      await this.testApiEndpoint(null, 'GET', '/api/auth/session', 'Auth - Session Check', undefined, undefined, 'Authentication');
      
      // 3. Áî®Êà∑ËÆ§ËØÅÊµãËØï
      console.log('\n=== 3. Êâ©Â±ïÁî®Êà∑ËÆ§ËØÅÊµãËØï ===');
      for (const user of this.extendedTestUsers) {
        try {
          const client = await this.createAuthenticatedClient(user);
          this.authenticatedClients.set(`${user.role}-${user.email}`, client);
        } catch (error) {
          // ÈîôËØØÂ∑≤Âú®createAuthenticatedClient‰∏≠ËÆ∞ÂΩï
        }
      }
      
      // 4. ÁÆ°ÁêÜÂëòAPIÂÖ®Èù¢ÊµãËØï
      console.log('\n=== 4. ÁÆ°ÁêÜÂëòAPIÂÖ®Èù¢ÊµãËØï ===');
      for (const [userKey, client] of this.authenticatedClients) {
        const user = this.extendedTestUsers.find(u => userKey.includes(u.email));
        if (!user) continue;
        
        console.log(`\n--- ÊµãËØï ${user.role} (${user.school || 'System'}) ÊùÉÈôê ---`);
        
        // Âü∫Á°ÄÁÆ°ÁêÜAPI
        await this.testApiEndpoint(client, 'GET', '/api/admin/stats', `Admin Stats - ${user.role}`, undefined, undefined, 'Admin API');
        await this.testApiEndpoint(client, 'GET', '/api/admin/numbers', `Admin Numbers List - ${user.role}`, undefined, undefined, 'Admin API');
        await this.testApiEndpoint(client, 'GET', '/api/admin/organizations', `Admin Organizations - ${user.role}`, undefined, undefined, 'Admin API');
        await this.testApiEndpoint(client, 'GET', '/api/admin/pending-orders', `Admin Pending Orders - ${user.role}`, undefined, undefined, 'Admin API');
        
        // Â∏¶ÂèÇÊï∞ÁöÑAPIÊµãËØï
        await this.testApiEndpoint(client, 'GET', '/api/admin/numbers', `Admin Numbers with Search - ${user.role}`, { search: '138', page: '1', limit: '10' }, undefined, 'Admin API');
        await this.testApiEndpoint(client, 'GET', '/api/admin/organizations', `Admin Organizations by Type - ${user.role}`, { type: 'SCHOOL' }, undefined, 'Admin API');
        
        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò‰∏ìÂ±ûÂäüËÉΩ
        if (user.role === 'SUPER_ADMIN') {
          await this.testApiEndpoint(client, 'POST', '/api/admin/actions', `Admin Actions - Clear Numbers - ${user.role}`, {
            action: 'CLEAR_ALL_NUMBERS',
            payload: {}
          }, undefined, 'Admin Actions');
          
          await this.testApiEndpoint(client, 'POST', '/api/admin/actions', `Admin Actions - Ban Prefix - ${user.role}`, {
            action: 'BAN_PREFIX',
            payload: { prefix: '138' }
          }, undefined, 'Admin Actions');
          
          await this.testApiEndpoint(client, 'POST', '/api/admin/actions', `Admin Actions - Unban Prefix - ${user.role}`, {
            action: 'UNBAN_PREFIX',
            payload: { prefix: '138' }
          }, undefined, 'Admin Actions');
        }
        
        // ÈáäÊîæË∂ÖÊó∂ËÆ¢Âçï
        await this.testApiEndpoint(client, 'POST', '/api/admin/release-overdue', `Release Overdue Orders - ${user.role}`, {}, undefined, 'Admin API');
      }
      
      // 5. ÊùÉÈôêËæπÁïåÊµãËØï
      console.log('\n=== 5. ÊùÉÈôêËæπÁïåÊµãËØï ===');
      const marketerClients = Array.from(this.authenticatedClients.entries())
        .filter(([key]) => key.includes('MARKETER'))
        .slice(0, 3); // ÊµãËØïÂâç3‰∏™ÈîÄÂîÆÂëò
      
      for (const [userKey, client] of marketerClients) {
        const user = this.extendedTestUsers.find(u => userKey.includes(u.email));
        if (!user) continue;
        
        // ÈîÄÂîÆ‰∫∫ÂëòÂ∞ùËØïËÆøÈóÆË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂäüËÉΩ
        await this.testApiEndpoint(client, 'POST', '/api/admin/actions', `Permission Boundary - ${user.name} accessing SUPER_ADMIN`, {
          action: 'CLEAR_ALL_NUMBERS',
          payload: {}
        }, 403, 'Permission Boundary');
        
        // ÈîÄÂîÆ‰∫∫ÂëòÂ∞ùËØïËÆøÈóÆÂÖ∂‰ªñÂ≠¶Ê†°Êï∞ÊçÆ
        const otherSchoolId = user.school === 'Âåó‰∫¨Â§ßÂ≠¶' ? 'school-2' : 'school-1';
        await this.testApiEndpoint(client, 'GET', '/api/admin/numbers', `Cross-School Data Access - ${user.name}`, {
          schoolId: otherSchoolId
        }, undefined, 'Permission Boundary');
      }
      
      // 6. Êï∞ÊçÆÂØºÂÖ•ÊµãËØï
      console.log('\n=== 6. Êï∞ÊçÆÂØºÂÖ•ÊµãËØï ===');
      const superAdminClient = this.authenticatedClients.get('SUPER_ADMIN-admin@system.com');
      if (superAdminClient) {
        // ÊµãËØïÊ†ºÂºè‰∏Ä (table1) - Âè∑Á†Å\tÂç°ÊùøÁä∂ÊÄÅ\tÊî∂Ê¨æÈáëÈ¢ù\tÂÆ¢Êà∑ÂßìÂêç\tÂ∑•‰Ωú‰∫∫Âëò
        const table1Data = `19067192804\tÂ∑≤È¢ÑÂÆö\tÂÖ®Ê¨æ200\tÁΩóÁÑ±Èò≥\tÁ¨¶Ëà™Â∫∑\n19067192814\tÂ∑≤È¢ÑÂÆö\tÂÖ®Ê¨æ200\tÊùéÊôìËïæ\tÁéãÊôìÈò≥\n19067192824\t\t\t\t\n19067192834\tÂ∑≤È¢ÑÂÆö\tÂÆöÈáë20\tÂ∏∏Ê†©Â∫∑\tÁ¨¶Ëà™Â∫∑`;
        
        await this.testApiEndpoint(superAdminClient, 'POST', '/api/admin/import-data', 'Data Import - Format 1 (Table1)', {
          data: table1Data,
          type: 'table1',
          schoolId: 'school-1',
          departmentId: 'dept-1'
        }, undefined, 'Data Import');
        
        // ÊµãËØïÊ†ºÂºè‰∫å (table2) - Â∫èÂè∑\tÂÆ¢Êà∑ÂßìÂêç\tÊñ∞ÈÄâÂè∑Á†Å\tÊñ∞ÈÄâÂè∑Á†ÅÂ∫èÂè∑\tËÅîÁ≥ªÂè∑Á†Å\tÈÇÆÂØÑÂú∞ÂùÄ\tÂø´ÈÄíÂçïÂè∑
        const table2Data = `1\tÂº†‰πêÊÄ°\t19067172615\t294\t13873195044\tÊπñÂçóÁúÅÈïøÊ≤ôÂ∏ÇÈõ®Ëä±Âå∫‰∏áÂÆ∂‰∏ΩÂçóË∑Ø27Âè∑Ëäô‰Ω≥Ëä±Âõ≠\t9879616972620\n2\tËÆ∏‰ªïÊù∞\t19067172095\t10\t13787030565\tÊπñÂçóÁúÅÈïøÊ≤ôÂ∏ÇÈõ®Ëä±Âå∫Â∑¶ÂÆ∂Â°òÊõôÂÖâÂ§ßÈÇ∏4Ê†ã1339\t9879616904980`;
        
        await this.testApiEndpoint(superAdminClient, 'POST', '/api/admin/import-data', 'Data Import - Format 2 (Table2)', {
          data: table2Data,
          type: 'table2',
          schoolId: 'school-1',
          departmentId: 'dept-1'
        }, undefined, 'Data Import');
        
        // ÊµãËØïÊô∫ËÉΩÂàÜÂâ≤ÂäüËÉΩ - ÂåÖÂê´Âú∞ÂùÄÊç¢Ë°åÁöÑÊï∞ÊçÆ
        const smartSplitData = `1\tÂº†‰πêÊÄ°\t19067172615\t294\t13873195044\tÊπñÂçóÁúÅÈïøÊ≤ôÂ∏ÇÈõ®Ëä±Âå∫‰∏áÂÆ∂‰∏ΩÂçóË∑Ø27Âè∑\nËäô‰Ω≥Ëä±Âõ≠\t9879616972620\n2\tËÆ∏‰ªïÊù∞\t19067172095\t10\t13787030565\tÊπñÂçóÁúÅÈïøÊ≤ôÂ∏ÇÈõ®Ëä±Âå∫Â∑¶ÂÆ∂Â°ò\nÊõôÂÖâÂ§ßÈÇ∏4Ê†ã1339\t9879616904980`;
        
        await this.testApiEndpoint(superAdminClient, 'POST', '/api/admin/import-data', 'Data Import - Smart Split with Address Newlines', {
          data: smartSplitData,
          type: 'table2',
          schoolId: 'school-1',
          departmentId: 'dept-1'
        }, undefined, 'Data Import');
        
        // ÊµãËØïÊó†ÊïàÊï∞ÊçÆÂØºÂÖ•
        await this.testApiEndpoint(superAdminClient, 'POST', '/api/admin/import-data', 'Data Import - Invalid Data', {
          data: 'invalid data without proper format',
          type: 'table1',
          schoolId: 'school-1'
        }, 400, 'Data Import');
        
        // ÊµãËØïÁº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞
        await this.testApiEndpoint(superAdminClient, 'POST', '/api/admin/import-data', 'Data Import - Missing School ID', {
          data: table1Data,
          type: 'table1'
        }, 400, 'Data Import');
      }
      
      // 7. ÈîôËØØÂ§ÑÁêÜÂíåËæπÁïåÊµãËØï
      console.log('\n=== 7. ÈîôËØØÂ§ÑÁêÜÂíåËæπÁïåÊµãËØï ===');
      await this.testApiEndpoint(null, 'GET', '/api/nonexistent', 'Error Handling - 404 Not Found', undefined, 404, 'Error Handling');
      await this.testApiEndpoint(null, 'GET', '/api/admin/stats', 'Error Handling - Unauthorized Admin Access', undefined, 401, 'Error Handling');
      await this.testApiEndpoint(null, 'POST', '/api/admin/stats', 'Error Handling - Method Not Allowed', {}, 405, 'Error Handling');
      
      // ÊµãËØïÊó†ÊïàÂèÇÊï∞ - ‰øÆÂ§çÊúüÊúõÁä∂ÊÄÅÁ†Å
      await this.testApiEndpoint(null, 'GET', '/api/numbers', 'Error Handling - Invalid Page Parameter', { page: 'invalid' }, 400, 'Error Handling');
      
      // 8. Âπ∂ÂèëÊµãËØï
      console.log('\n=== 8. Âπ∂ÂèëÊµãËØï ===');
      await this.runConcurrentTests();
      
      // 9. ÊÄßËÉΩÊµãËØï
      console.log('\n=== 9. ÊÄßËÉΩÊµãËØï ===');
      await this.runPerformanceTests();
      
    } catch (error: any) {
      console.error('‚ùå ÊµãËØïÊâßË°åÂ§±Ë¥•:', error.message);
      this.logResult('Test Execution', false, undefined, error.message);
    }
    
    return this.generateExtendedReport();
  }

  private async runConcurrentTests() {
    const concurrentPromises = [];
    
    // ÂêåÊó∂ÂèëÈÄÅÂ§ö‰∏™ËØ∑Ê±ÇÊµãËØïÂπ∂ÂèëÂ§ÑÁêÜ
    for (let i = 0; i < 5; i++) {
      concurrentPromises.push(
        this.testApiEndpoint(null, 'GET', '/api/numbers', `Concurrent Test ${i + 1}`, { page: i + 1 }, undefined, 'Concurrency')
      );
    }
    
    await Promise.all(concurrentPromises);
  }

  private async runPerformanceTests() {
    // Â§ßÊï∞ÊçÆÈáèÊü•ËØ¢ÊµãËØï
    await this.testApiEndpoint(null, 'GET', '/api/numbers', 'Performance - Large Dataset Query', { limit: '100' }, undefined, 'Performance');
    
    // Â§çÊùÇÊü•ËØ¢ÊµãËØï
    const superAdminClient = this.authenticatedClients.get('SUPER_ADMIN-admin@system.com');
    if (superAdminClient) {
      await this.testApiEndpoint(superAdminClient, 'GET', '/api/admin/numbers', 'Performance - Complex Admin Query', {
        search: '138',
        page: '1',
        limit: '50',
        sort: JSON.stringify({ field: 'phoneNumber', direction: 'asc' })
      }, undefined, 'Performance');
    }
  }

  private generateExtendedReport(): ExtendedTestReport {
    const endTime = new Date();
    const duration = endTime.getTime() - this.startTime.getTime();
    const passed = this.testResults.filter(r => r.success).length;
    const failed = this.testResults.filter(r => !r.success).length;
    const failedTests = this.testResults.filter(r => !r.success);
    
    // ÊåâÁî®Êà∑ËßíËâ≤ÂàÜÁªÑÊµãËØïÁªìÊûú
    const userTests: Record<string, TestResult[]> = {};
    this.testResults.forEach(result => {
      const roleMatch = result.testName.match(/- (SUPER_ADMIN|SCHOOL_ADMIN|MARKETER)/);;
      if (roleMatch) {
        const role = roleMatch[1];
        if (!userTests[role]) userTests[role] = [];
        userTests[role].push(result);
      }
    });
    
    // ÊåâÊµãËØïÁ±ªÂà´ÂàÜÁªÑ
    const testCategories: Record<string, { passed: number; total: number }> = {};
    this.testResults.forEach(result => {
      const categoryMatch = result.testName.match(/\[([^\]]+)\]/);
      const category = categoryMatch ? categoryMatch[1] : 'General';
      
      if (!testCategories[category]) {
        testCategories[category] = { passed: 0, total: 0 };
      }
      
      testCategories[category].total++;
      if (result.success) {
        testCategories[category].passed++;
      }
    });
    
    // ËÆ°ÁÆóÊÄßËÉΩÊåáÊ†á
    const responseTimes = this.testResults
      .filter(r => r.responseTime)
      .map(r => ({ endpoint: r.testName, time: r.responseTime! }));
    
    const averageResponseTime = responseTimes.length > 0 
      ? responseTimes.reduce((sum, r) => sum + r.time, 0) / responseTimes.length 
      : 0;
    
    const slowestEndpoint = responseTimes.length > 0 
      ? responseTimes.reduce((max, r) => r.time > max.time ? r : max)
      : { endpoint: 'N/A', time: 0 };
    
    const fastestEndpoint = responseTimes.length > 0 
      ? responseTimes.reduce((min, r) => r.time < min.time ? r : min)
      : { endpoint: 'N/A', time: 0 };
    
    // APIË¶ÜÁõñÁéáÁªüËÆ°
    const allEndpoints = [
      'GET /', 'GET /api/numbers', 'GET /api/auth/csrf', 'GET /api/auth/session',
      'GET /api/admin/stats', 'GET /api/admin/numbers', 'GET /api/admin/organizations',
      'GET /api/admin/pending-orders', 'POST /api/admin/actions', 'POST /api/admin/release-overdue',
      'POST /api/admin/import-data'
    ];
    
    const endpointDetails: Record<string, { tested: boolean; methods: string[] }> = {};
    allEndpoints.forEach(endpoint => {
      const [method, path] = endpoint.split(' ');
      if (!endpointDetails[path]) {
        endpointDetails[path] = { tested: false, methods: [] };
      }
      endpointDetails[path].methods.push(method);
      if (this.testedEndpoints.has(endpoint)) {
        endpointDetails[path].tested = true;
      }
    });
    
    const testedEndpointsCount = Object.values(endpointDetails).filter(e => e.tested).length;
    const coverage = (testedEndpointsCount / Object.keys(endpointDetails).length) * 100;
    
    const report: ExtendedTestReport = {
      summary: {
        total: this.testResults.length,
        passed,
        failed,
        duration,
        timestamp: endTime.toISOString(),
        testCategories
      },
      testResults: this.testResults,
      failedTests,
      userTests,
      apiCoverage: {
        totalEndpoints: Object.keys(endpointDetails).length,
        testedEndpoints: testedEndpointsCount,
        coverage: Math.round(coverage * 100) / 100,
        endpointDetails
      },
      performanceMetrics: {
        averageResponseTime: Math.round(averageResponseTime * 100) / 100,
        slowestEndpoint,
        fastestEndpoint
      }
    };
    
    this.printExtendedReport(report);
    this.saveExtendedJsonReport(report);
    
    return report;
  }

  private printExtendedReport(report: ExtendedTestReport) {
    console.log('\n' + '='.repeat(100));
    console.log('üìä Êâ©Â±ïAPIÊµãËØïÊä•ÂëäÊÄªÁªì');
    console.log('='.repeat(100));
    console.log(`üìà ÊÄªÊµãËØïÊï∞: ${report.summary.total}`);
    console.log(`‚úÖ ÈÄöËøá: ${report.summary.passed}`);
    console.log(`‚ùå Â§±Ë¥•: ${report.summary.failed}`);
    console.log(`üìä ÊàêÂäüÁéá: ${((report.summary.passed / report.summary.total) * 100).toFixed(2)}%`);
    console.log(`‚è±Ô∏è  ÊÄªËÄóÊó∂: ${(report.summary.duration / 1000).toFixed(2)}Áßí`);
    console.log(`üéØ APIË¶ÜÁõñÁéá: ${report.apiCoverage.coverage}% (${report.apiCoverage.testedEndpoints}/${report.apiCoverage.totalEndpoints})`);
    
    console.log('\nüìä ÊåâÊµãËØïÁ±ªÂà´ÁªüËÆ°:');
    Object.entries(report.summary.testCategories).forEach(([category, stats]) => {
      const percentage = ((stats.passed / stats.total) * 100).toFixed(1);
      console.log(`   ${category}: ${stats.passed}/${stats.total} (${percentage}%)`);
    });
    
    console.log('\n‚ö° ÊÄßËÉΩÊåáÊ†á:');
    console.log(`   Âπ≥ÂùáÂìçÂ∫îÊó∂Èó¥: ${report.performanceMetrics.averageResponseTime}ms`);
    console.log(`   ÊúÄÊÖ¢Á´ØÁÇπ: ${report.performanceMetrics.slowestEndpoint.endpoint} (${report.performanceMetrics.slowestEndpoint.time}ms)`);
    console.log(`   ÊúÄÂø´Á´ØÁÇπ: ${report.performanceMetrics.fastestEndpoint.endpoint} (${report.performanceMetrics.fastestEndpoint.time}ms)`);
    
    if (report.failedTests.length > 0) {
      console.log('\n‚ùå Â§±Ë¥•ÁöÑÊµãËØï:');
      report.failedTests.forEach(test => {
        console.log(`   ‚Ä¢ ${test.testName}: ${test.errorMessage}`);
      });
    }
    
    console.log('\nüë• ÊåâËßíËâ≤ÂàÜÁªÑÁöÑÊµãËØïÁªìÊûú:');
    Object.entries(report.userTests).forEach(([role, tests]) => {
      const rolePassed = tests.filter(t => t.success).length;
      const roleTotal = tests.length;
      console.log(`   ${role}: ${rolePassed}/${roleTotal} (${((rolePassed/roleTotal)*100).toFixed(1)}%)`);
    });
    
    console.log('\nüéØ Êâ©Â±ïÊµãËØïÁî®Êà∑‰ø°ÊÅØ:');
    console.log('=== ÁÆ°ÁêÜÂëòË¥¶Âè∑ ===');
    this.extendedTestUsers.filter(u => u.role.includes('ADMIN')).forEach(user => {
      console.log(`   ‚Ä¢ ${user.role} (${user.school || 'System'}): ${user.email}`);
    });
    
    console.log('\n=== ÈîÄÂîÆÂëòË¥¶Âè∑ ===');
    this.extendedTestUsers.filter(u => u.role === 'MARKETER').forEach(user => {
      console.log(`   ‚Ä¢ ${user.name} (${user.school}/${user.department}): ${user.email}`);
    });
    
    console.log('\n' + '='.repeat(100));
  }

  private saveExtendedJsonReport(report: ExtendedTestReport) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    
    const jsonReportPath = path.join(process.cwd(), `extended-api-test-report-${timestamp}.json`);
    fs.writeFileSync(jsonReportPath, JSON.stringify(report, null, 2));
    console.log(`üìÑ Êâ©Â±ïÊµãËØïÊä•ÂëäÂ∑≤‰øùÂ≠ò: ${jsonReportPath}`);
  }
}

// ‰∏ªÊâßË°åÂáΩÊï∞
async function main() {
  const baseUrl = process.env.TEST_BASE_URL || 'http://localhost:3000';
  const tester = new ExtendedAPITester(baseUrl);
  
  try {
    const report = await tester.runExtendedTests();
    
    // Ê†πÊçÆÊµãËØïÁªìÊûúËÆæÁΩÆÈÄÄÂá∫Á†Å
    const exitCode = report.summary.failed > 0 ? 1 : 0;
    process.exit(exitCode);
    
  } catch (error) {
    console.error('‚ùå Êâ©Â±ïÊµãËØïÊâßË°åÂ§±Ë¥•:', error);
    process.exit(1);
  }
}

// Â¶ÇÊûúÁõ¥Êé•ËøêË°åÊ≠§ËÑöÊú¨
if (require.main === module) {
  main();
}

export { ExtendedAPITester };