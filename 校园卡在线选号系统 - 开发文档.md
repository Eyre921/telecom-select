**版本：** V1.0-Production

**创建时间：** 2025年8月

**技术栈：** Next.js 14 + TypeScript + Prisma + SQLite

  

## 1. 项目概述

  

### 1.1 技术架构

  

本项目采用现代化的全栈Web开发技术栈：

  

- **前端框架：** Next.js 14 (App Router)
    
- **开发语言：** TypeScript
    
- **样式框架：** Tailwind CSS
    
- **数据库ORM：** Prisma
    
- **数据库：** SQLite (生产环境可切换PostgreSQL)
    
- **身份认证：** NextAuth.js
    
- **部署方式：** PM2 + Standalone模式
    
      
    

### 1.2 项目结构

  

```Plain
telecom-select-system/
├── prisma/                    # 数据库相关
│   ├── schema.prisma         # 数据库模型定义
│   ├── dev.db               # SQLite数据库文件
│   └── migrations/          # 数据库迁移文件
├── src/
│   ├── app/                 # Next.js App Router
│   │   ├── api/            # API路由
│   │   │   ├── auth/       # 身份认证API
│   │   │   ├── numbers/    # 号码管理API
│   │   │   ├── orders/     # 订单管理API
│   │   │   └── admin/      # 管理员API
│   │   ├── admin/          # 管理后台页面
│   │   │   ├── dashboard/  # 仪表盘
│   │   │   └── import/     # 数据导入
│   │   ├── signin/         # 登录页面
│   │   └── page.tsx        # 客户端首页
│   ├── components/         # React组件
│   │   ├── ui/            # 通用UI组件
│   │   └── admin/         # 管理后台组件
│   ├── lib/               # 工具库
│   │   ├── auth.ts        # 认证配置
│   │   ├── prisma.ts      # 数据库连接
│   │   └── utils.ts       # 工具函数
│   └── types/             # TypeScript类型定义
└── package.json          # 项目依赖
```

  

## 2. 核心功能模块

  

### 2.1 数据库设计

  

#### 2.1.1 核心表结构

  

**PhoneNumber 表（号码表）**

  

```TypeScript
model PhoneNumber {
  id                  String             @id @default(cuid())
  phoneNumber         String             @unique
  isPremium           Boolean            @default(false)
  premiumReason       String?
  reservationStatus   ReservationStatus  @default(UNRESERVED)
  orderTimestamp      DateTime?
  paymentAmount       Float?
  paymentMethod       PaymentMethod?
  transactionId       String?
  assignedMarketer    String?
  customerName        String?
  customerContact     String?
  shippingAddress     String?
  emsTrackingNumber   String?
  deliveryStatus      DeliveryStatus?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}
```

  

**User 表（用户表）**

  

```TypeScript
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  password      String?   // 加密存储
  role          Role      @default(MARKETER)
  // NextAuth.js 关联表
  accounts      Account[]
  sessions      Session[]
}
```

  

#### 2.1.2 枚举类型

  

```TypeScript
enum ReservationStatus {
  UNRESERVED      // 未预定
  PENDING_REVIEW  // 审核中
  RESERVED        // 已预定
}

enum PaymentMethod {
  WECHAT   // 微信
  ALIPAY   // 支付宝
  CASH     // 现金
  OTHER    // 其他
}

enum DeliveryStatus {
  EMPTY                    // 空
  IN_TRANSIT_UNACTIVATED  // 在途未激活
  IN_TRANSIT_ACTIVATED    // 在途已激活
  RECEIVED_UNACTIVATED    // 已收到未激活
}

enum Role {
  ADMIN     // 管理员
  MARKETER  // 营销人员
}
```

  

### 2.2 API接口设计

  

#### 2.2.1 号码管理 API

  

**GET /api/numbers**

- 功能：获取号码列表
    
- 参数：
    
    - `page`: 页码
        
    - `hideReserved`: 是否隐藏已预定号码
        
- 返回：号码列表数据
    
      
    

```TypeScript
// 实现示例
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get('page') || '1', 10);
  const hideReserved = searchParams.get('hideReserved') === 'true';
  
  const where = hideReserved ? 
    { reservationStatus: 'UNRESERVED' } : {};
  
  const phoneNumbers = await prisma.phoneNumber.findMany({
    where,
    orderBy: [
      { isPremium: 'desc' },
      { phoneNumber: 'asc' }
    ],
    skip: (page - 1) * 100,
    take: 100
  });
  
  return NextResponse.json(phoneNumbers);
}
```

  

#### 2.2.2 订单管理 API

  

**POST /api/orders**

- 功能：创建新订单
    
- 参数：号码ID、客户信息、支付金额等
    
- 特色：使用数据库事务确保并发安全
    
      
    

```TypeScript
export async function POST(request: Request) {
  const body = await request.json();
  
  // 使用事务防止并发问题
  const updatedNumber = await prisma.$transaction(async (tx) => {
    const numberToReserve = await tx.phoneNumber.findUnique({
      where: { id: body.numberId }
    });
    
    if (numberToReserve?.reservationStatus !== 'UNRESERVED') {
      throw new Error('该号码已被预定或正在审核中');
    }
    
    return tx.phoneNumber.update({
      where: { id: body.numberId },
      data: {
        reservationStatus: 'PENDING_REVIEW',
        orderTimestamp: new Date(),
        customerName: body.customerName,
        customerContact: body.customerContact,
        shippingAddress: body.shippingAddress,
        paymentAmount: parseFloat(body.paymentAmount)
      }
    });
  });
  
  return NextResponse.json(updatedNumber);
}
```

  

### 2.3 身份认证系统

  

#### 2.3.1 NextAuth.js 配置

  

<mcfile name="auth.ts" path="src/lib/auth.ts"></mcfile>

  

```TypeScript
import { NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import bcrypt from 'bcryptjs';
import prisma from './prisma';

export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }
        
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        });
        
        if (!user || !user.password) {
          return null;
        }
        
        const isPasswordValid = await bcrypt.compare(
          credentials.password, 
          user.password
        );
        
        if (!isPasswordValid) {
          return null;
        }
        
        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        };
      }
    })
  ],
  session: {
    strategy: 'jwt'
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.id = token.sub!;
        session.user.role = token.role as string;
      }
      return session;
    }
  }
};
```

  

#### 2.3.2 权限控制中间件

  

```TypeScript
// 权限检查函数
export async function checkAdminPermission(request: NextRequest) {
  const session = await getServerSession(authOptions);
  
  if (!session || session.user.role !== 'ADMIN') {
    return new NextResponse('Unauthorized', { status: 401 });
  }
  
  return null;
}
```

  

## 3. 前端组件架构

  

### 3.1 客户端组件

  

#### 3.1.1 号码卡片组件

  

<mcfile name="NumberCard.tsx" path="src/components/ui/NumberCard.tsx"></mcfile>

  

```TypeScript
interface NumberCardProps {
  number: PhoneNumber;
  onSelect: (number: PhoneNumber) => void;
  isSelectable: boolean;
}

export const NumberCard = ({ number, onSelect, isSelectable }: NumberCardProps) => {
  const handleCopy = async (phoneNumber: string) => {
    try {
      await navigator.clipboard.writeText(phoneNumber);
      // 显示复制成功提示
    } catch (err) {
      console.error('复制失败:', err);
    }
  };
  
  return (
    <div className={`
      relative p-4 border rounded-lg transition-all duration-200
      ${isSelectable ? 'hover:shadow-md cursor-pointer' : 'opacity-50'}
      ${number.isPremium ? 'border-red-300 bg-red-50' : 'border-gray-200'}
    `}>
      {number.isPremium && (
        <div className="absolute -top-2 -right-2">
          <span className="text-red-500">👑</span>
        </div>
      )}
      
      <div className="text-lg font-mono font-bold">
        {number.phoneNumber}
      </div>
      
      {number.isPremium && (
        <div className="text-xs text-red-600 mt-1">
          {number.premiumReason}
        </div>
      )}
      
      <div className="flex justify-between items-center mt-2">
        <button
          onClick={() => handleCopy(number.phoneNumber)}
          className="text-xs text-gray-500 hover:text-gray-700"
        >
          📋 复制
        </button>
        
        {isSelectable && (
          <button
            onClick={() => onSelect(number)}
            className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
          >
            选择
          </button>
        )}
      </div>
    </div>
  );
};
```

  

#### 3.1.2 订单模态框组件

  

<mcfile name="OrderModal.tsx" path="src/components/ui/OrderModal.tsx"></mcfile>

  

```TypeScript
interface OrderModalProps {
  number: PhoneNumber | null;
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (orderData: OrderData) => void;
}

export const OrderModal = ({ number, isOpen, onClose, onSubmit }: OrderModalProps) => {
  const [formData, setFormData] = useState({
    customerName: '',
    customerContact: '',
    shippingAddress: '',
    paymentAmount: 20
  });
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // 表单验证
    if (!formData.customerName || !formData.customerContact) {
      alert('请填写必要信息');
      return;
    }
    
    if (formData.paymentAmount === 200 && !formData.shippingAddress) {
      alert('选择200元全款时必须填写收货地址');
      return;
    }
    
    onSubmit({
      numberId: number!.id,
      ...formData
    });
  };
  
  if (!isOpen || !number) return null;
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <h2 className="text-xl font-bold mb-4">预定号码</h2>
        
        <div className="mb-4 p-3 bg-blue-50 rounded">
          <div className="text-lg font-mono font-bold text-blue-800">
            {number.phoneNumber}
          </div>
          {number.isPremium && (
            <div className="text-sm text-red-600">
              👑 {number.premiumReason}
            </div>
          )}
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          {/* 支付方式选择 */}
          <div>
            <label className="block text-sm font-medium mb-2">支付方式</label>
            <div className="space-y-2">
              <label className="flex items-center">
                <input
                  type="radio"
                  name="paymentAmount"
                  value={20}
                  checked={formData.paymentAmount === 20}
                  onChange={(e) => setFormData({...formData, paymentAmount: 20})}
                  className="mr-2"
                />
                <span>20元定金（到校后补齐180元）</span>
              </label>
              <label className="flex items-center">
                <input
                  type="radio"
                  name="paymentAmount"
                  value={200}
                  checked={formData.paymentAmount === 200}
                  onChange={(e) => setFormData({...formData, paymentAmount: 200})}
                  className="mr-2"
                />
                <span>200元全款（包邮到宿舍）</span>
              </label>
            </div>
          </div>
          
          {/* 客户信息表单 */}
          <div>
            <label className="block text-sm font-medium mb-1">姓名 *</label>
            <input
              type="text"
              value={formData.customerName}
              onChange={(e) => setFormData({...formData, customerName: e.target.value})}
              className="w-full p-2 border rounded"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">联系电话 *</label>
            <input
              type="tel"
              value={formData.customerContact}
              onChange={(e) => setFormData({...formData, customerContact: e.target.value})}
              className="w-full p-2 border rounded"
              required
            />
          </div>
          
          {formData.paymentAmount === 200 && (
            <div>
              <label className="block text-sm font-medium mb-1">收货地址 *</label>
              <textarea
                value={formData.shippingAddress}
                onChange={(e) => setFormData({...formData, shippingAddress: e.target.value})}
                className="w-full p-2 border rounded h-20"
                placeholder="请填写详细的收货地址"
                required
              />
            </div>
          )}
          
          <div className="flex space-x-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-2 border border-gray-300 rounded hover:bg-gray-50"
            >
              取消
            </button>
            <button
              type="submit"
              className="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              提交订单
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
```

  

### 3.2 管理后台组件

  

#### 3.2.1 数据统计卡片

  

<mcfile name="StatsCards.tsx" path="src/components/admin/StatsCards.tsx"></mcfile>

  

```TypeScript
interface StatsCardsProps {
  totalNumbers: number;
  availableNumbers: number;
  pendingOrders: number;
  todayOrders: number;
}

export const StatsCards = ({ 
  totalNumbers, 
  availableNumbers, 
  pendingOrders, 
  todayOrders 
}: StatsCardsProps) => {
  const stats = [
    {
      title: '总号码数',
      value: totalNumbers,
      icon: '📱',
      color: 'bg-blue-500'
    },
    {
      title: '剩余可选',
      value: availableNumbers,
      icon: '✅',
      color: 'bg-green-500'
    },
    {
      title: '待审核订单',
      value: pendingOrders,
      icon: '⏳',
      color: 'bg-yellow-500'
    },
    {
      title: '今日新增订单',
      value: todayOrders,
      icon: '📈',
      color: 'bg-purple-500'
    }
  ];
  
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      {stats.map((stat, index) => (
        <div key={index} className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className={`${stat.color} rounded-full p-3 text-white text-2xl mr-4`}>
              {stat.icon}
            </div>
            <div>
              <p className="text-sm font-medium text-gray-600">{stat.title}</p>
              <p className="text-2xl font-bold text-gray-900">{stat.value}</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};
```

  

#### 3.2.2 待审核订单表格

  

<mcfile name="PendingOrdersTable.tsx" path="src/components/admin/PendingOrdersTable.tsx"></mcfile>

  

```TypeScript
interface PendingOrdersTableProps {
  initialPendingNumbers: PhoneNumber[];
  onApprove: (number: PhoneNumber) => void;
  onRelease: (numberId: string) => void;
}

export const PendingOrdersTable = ({ 
  initialPendingNumbers, 
  onApprove, 
  onRelease 
}: PendingOrdersTableProps) => {
  const [pendingNumbers, setPendingNumbers] = useState(initialPendingNumbers);
  
  // 计算倒计时
  const formatTimeLeft = (timestamp: string | Date): string => {
    const orderTime = new Date(timestamp).getTime();
    const now = new Date().getTime();
    const diffMinutes = Math.floor((now - orderTime) / (1000 * 60));
    
    if (diffMinutes >= 30) {
      return "已超时";
    }
    
    const timeLeft = 30 - diffMinutes;
    return `${timeLeft} 分钟后超时`;
  };
  
  const handleRelease = async (numberId: string) => {
    if (!confirm('确定要手动释放这个号码吗？')) return;
    onRelease(numberId);
  };
  
  return (
    <div className="mb-8">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold">待审核订单</h2>
        <div className="text-sm text-gray-600">
          共 {pendingNumbers.length} 个待审核订单
        </div>
      </div>
      
      {pendingNumbers.length === 0 ? (
        <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
          暂无待审核订单
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  号码
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  客户信息
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  支付金额
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  下单时间
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  操作
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {pendingNumbers.map((number) => {
                const isOvertime = number.orderTimestamp && 
                  (new Date().getTime() - new Date(number.orderTimestamp).getTime()) > 30 * 60 * 1000;
                
                return (
                  <tr key={number.id} className={isOvertime ? 'bg-red-50' : ''}>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <span className="font-mono font-bold">{number.phoneNumber}</span>
                        {number.isPremium && (
                          <span className="ml-2 text-red-500">👑</span>
                        )}
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="font-medium">{number.customerName}</div>
                        <div className="text-sm text-gray-500">{number.customerContact}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className="font-bold text-green-600">
                        ¥{number.paymentAmount}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div>
                        <div className="text-sm">
                          {number.orderTimestamp && 
                            new Date(number.orderTimestamp).toLocaleString()}
                        </div>
                        <div className={`text-xs ${
                          isOvertime ? 'text-red-600 font-bold' : 'text-gray-500'
                        }`}>
                          {number.orderTimestamp && formatTimeLeft(number.orderTimestamp)}
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                      <button
                        onClick={() => onApprove(number)}
                        className="text-green-600 hover:text-green-900"
                      >
                        批准
                      </button>
                      <button
                        onClick={() => handleRelease(number.id)}
                        className="text-red-600 hover:text-red-900"
                      >
                        释放
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};
```

  

## 4. 核心业务逻辑

  

### 4.1 并发安全机制

  

#### 4.1.1 数据库事务

  

```TypeScript
// 防止号码重复预定的事务处理
const reserveNumber = async (numberId: string, orderData: OrderData) => {
  return await prisma.$transaction(async (tx) => {
    // 1. 检查号码状态
    const number = await tx.phoneNumber.findUnique({
      where: { id: numberId }
    });
    
    if (!number || number.reservationStatus !== 'UNRESERVED') {
      throw new Error('号码不可用');
    }
    
    // 2. 更新号码状态
    return await tx.phoneNumber.update({
      where: { id: numberId },
      data: {
        reservationStatus: 'PENDING_REVIEW',
        orderTimestamp: new Date(),
        ...orderData
      }
    });
  });
};
```

  

### 4.2 靓号自动识别

  

```TypeScript
// 靓号识别算法
const analyzePremiumNumber = (phoneNumber: string): {
  isPremium: boolean;
  reason?: string;
} => {
  const number = phoneNumber.slice(-8); // 取后8位
  
  // 连号检测
  const hasConsecutive = /012|123|234|345|456|567|678|789|987|876|765|654|543|432|321|210/.test(number);
  if (hasConsecutive) {
    return { isPremium: true, reason: '连号' };
  }
  
  // 重复号码检测
  const hasRepeating = /([0-9])\1{2,}/.test(number);
  if (hasRepeating) {
    return { isPremium: true, reason: '重复号码' };
  }
  
  // 对称号码检测
  const isSymmetric = number === number.split('').reverse().join('');
  if (isSymmetric) {
    return { isPremium: true, reason: '对称号码' };
  }
  
  // 特殊号码检测
  const specialPatterns = [
    { pattern: /8888|6666|9999/, reason: '吉祥号码' },
    { pattern: /1314|520|1688/, reason: '寓意号码' }
  ];
  
  for (const { pattern, reason } of specialPatterns) {
    if (pattern.test(number)) {
      return { isPremium: true, reason };
    }
  }
  
  return { isPremium: false };
};
```

  

### 4.3 数据导入处理

  

```TypeScript
// 批量数据导入逻辑
const importPhoneNumbers = async (data: any[], fieldMapping: FieldMapping) => {
  const results = [];
  
  for (const row of data) {
    try {
      const phoneNumber = row[fieldMapping.phoneNumber];
      
      if (!phoneNumber) {
        results.push({ success: false, error: '号码不能为空' });
        continue;
      }
      
      // 靓号分析
      const premiumAnalysis = analyzePremiumNumber(phoneNumber);
      
      // 准备数据
      const numberData = {
        phoneNumber,
        isPremium: premiumAnalysis.isPremium,
        premiumReason: premiumAnalysis.reason,
        customerName: row[fieldMapping.customerName] || null,
        assignedMarketer: row[fieldMapping.assignedMarketer] || null,
        // ... 其他字段映射
      };
      
      // 使用 upsert 进行插入或更新
      await prisma.phoneNumber.upsert({
        where: { phoneNumber },
        update: numberData,
        create: numberData
      });
      
      results.push({ success: true, phoneNumber });
    } catch (error) {
      results.push({ 
        success: false, 
        phoneNumber: row[fieldMapping.phoneNumber],
        error: error.message 
      });
    }
  }
  
  return results;
};
```

  

## 5. 部署与运维

  

### 5.1 生产环境配置

  

#### 5.1.1 环境变量

  

```Bash
# .env 文件
DATABASE_URL="file:./prisma/dev.db"
NEXTAUTH_URL="https://domain.com"
NEXTAUTH_SECRET="your-secret-key"
NODE_ENV="production"
PORT=3000
```

  

#### 5.1.2 部署脚本

  

<mcfile name="deploy.bat" path="deploy.bat"></mcfile>

  

```Bash
@echo off
echo 正在配置生产环境...

:: 设置环境变量
echo DATABASE_URL="file:./prisma/dev.db" > .env.local
echo NEXTAUTH_URL="https://domain.com" >> .env.local
echo NEXTAUTH_SECRET="your-nextauth-secret-key" >> .env.local
echo NODE_ENV="production" >> .env.local
echo PORT=3000 >> .env.local

:: 安装依赖
npm install --production

:: 生成 Prisma 客户端
npx prisma generate

:: 运行数据库迁移
npx prisma db push

:: 构建应用
npm run build

echo 部署完成！
echo 请使用以下命令启动应用：
echo pm2 start server.js --name telecom-app
pause
```

  

### 5.2 PM2 配置

  

#### 5.2.1 生态系统配置

  

```TypeScript
module.exports = {
  apps: [{
    name: 'telecom-app',
    script: 'server.js',
    cwd: '/www/wwwroot/telecom',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
      DATABASE_URL: 'file:./prisma/dev.db',
      NEXTAUTH_URL: 'https://domain.com',
      NEXTAUTH_SECRET: 'your-secret-key'
    },
    instances: 1,
    exec_mode: 'fork',
    watch: false,
    max_memory_restart: '1G',
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

  

#### 5.2.2 常用命令

  

```Bash
# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs telecom-app

# 重启应用
pm2 restart telecom-app

# 停止应用
pm2 stop telecom-app

# 删除应用
pm2 delete telecom-app
```

  

### 5.3 数据库维护

  

#### 5.3.1 备份脚本

  

```Bash
#!/bin/bash
# backup.sh

DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="/backup/telecom"
DB_FILE="/www/wwwroot/telecom/prisma/dev.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 复制数据库文件
cp $DB_FILE $BACKUP_DIR/dev_$DATE.db

# 压缩备份
gzip $BACKUP_DIR/dev_$DATE.db

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "数据库备份完成: dev_$DATE.db.gz"
```

  

#### 5.3.2 数据库迁移

  

```Bash
# 生成迁移文件
npx prisma migrate dev --name add_new_field

# 应用迁移到生产环境
npx prisma migrate deploy

# 重置数据库（开发环境）
npx prisma migrate reset

# 查看迁移状态
npx prisma migrate status
```

  

## 6. 性能优化

  

### 6.1 前端优化

  

#### 6.1.1 无限滚动实现

  

```TypeScript
// 使用 Intersection Observer 实现无限滚动
const useInfiniteScroll = (callback: () => void) => {
  const [isFetching, setIsFetching] = useState(false);
  const loaderRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !isFetching) {
          setIsFetching(true);
          callback();
        }
      },
      { threshold: 0.1 }
    );
    
    if (loaderRef.current) {
      observer.observe(loaderRef.current);
    }
    
    return () => observer.disconnect();
  }, [callback, isFetching]);
  
  return { loaderRef, isFetching, setIsFetching };
};
```

  

#### 6.1.2 组件懒加载

  

```TypeScript
// 动态导入组件
const ExportModal = dynamic(() => import('@/components/admin/ExportModal'), {
  loading: () => <div>加载中...</div>,
  ssr: false
});

const ImportPage = dynamic(() => import('@/app/admin/import/page'), {
  loading: () => <div>加载中...</div>
});
```

  

### 6.2 后端优化

  

#### 6.2.1 数据库查询优化

  

```TypeScript
// 使用索引优化查询
const getNumbersWithPagination = async (page: number, hideReserved: boolean) => {
  const where = hideReserved ? { reservationStatus: 'UNRESERVED' } : {};
  
  return await prisma.phoneNumber.findMany({
    where,
    select: {
      id: true,
      phoneNumber: true,
      isPremium: true,
      premiumReason: true,
      reservationStatus: true
    }, // 只选择需要的字段
    orderBy: [
      { isPremium: 'desc' },
      { phoneNumber: 'asc' }
    ],
    skip: (page - 1) * 100,
    take: 100
  });
};
```

  

#### 6.2.2 缓存策略

  

```TypeScript
// 使用 Next.js 缓存
export async function GET(request: NextRequest) {
  const response = NextResponse.json(data);
  
  // 设置缓存头
  response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=300');
  
  return response;
}
```

  

## 7. 安全性考虑

  

### 7.1 输入验证

  

```TypeScript
// 使用 Zod 进行输入验证
import { z } from 'zod';

const OrderSchema = z.object({
  numberId: z.string().cuid(),
  customerName: z.string().min(1).max(50),
  customerContact: z.string().regex(/^1[3-9]\d{9}$/),
  paymentAmount: z.number().positive(),
  shippingAddress: z.string().optional()
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const validatedData = OrderSchema.parse(body);
    
    // 处理验证后的数据
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new NextResponse('输入数据无效', { status: 400 });
    }
  }
}
```

  

### 7.2 权限控制

  

```TypeScript
// API 路由权限中间件
const withAuth = (handler: Function, requiredRole?: Role) => {
  return async (request: NextRequest) => {
    const session = await getServerSession(authOptions);
    
    if (!session) {
      return new NextResponse('未授权', { status: 401 });
    }
    
    if (requiredRole && session.user.role !== requiredRole) {
      return new NextResponse('权限不足', { status: 403 });
    }
    
    return handler(request);
  };
};

// 使用示例
export const DELETE = withAuth(async (request: NextRequest) => {
  // 只有管理员可以删除
}, 'ADMIN');
```

  

## 8. 测试策略

  

### 8.1 单元测试

  

```TypeScript
// __tests__/utils.test.ts
import { analyzePremiumNumber } from '@/lib/utils';

describe('analyzePremiumNumber', () => {
  test('应该识别连号', () => {
    const result = analyzePremiumNumber('18812345678');
    expect(result.isPremium).toBe(true);
    expect(result.reason).toBe('连号');
  });
  
  test('应该识别重复号码', () => {
    const result = analyzePremiumNumber('18888888888');
    expect(result.isPremium).toBe(true);
    expect(result.reason).toBe('重复号码');
  });
  
  test('普通号码不应该被标记为靓号', () => {
    const result = analyzePremiumNumber('18812349876');
    expect(result.isPremium).toBe(false);
  });
});
```

  

### 8.2 集成测试

  

```TypeScript
// __tests__/api/orders.test.ts
import { POST } from '@/app/api/orders/route';
import { NextRequest } from 'next/server';

describe('/api/orders', () => {
  test('应该成功创建订单', async () => {
    const request = new NextRequest('http://localhost:3000/api/orders', {
      method: 'POST',
      body: JSON.stringify({
        numberId: 'test-id',
        customerName: '测试用户',
        customerContact: '13800138000',
        paymentAmount: 20
      })
    });
    
    const response = await POST(request);
    expect(response.status).toBe(201);
  });
  
  test('应该拒绝无效输入', async () => {
    const request = new NextRequest('http://localhost:3000/api/orders', {
      method: 'POST',
      body: JSON.stringify({
        numberId: 'test-id'
        // 缺少必要字段
      })
    });
    
    const response = await POST(request);
    expect(response.status).toBe(400);
  });
});
```

  

## 9. 监控与日志

  

### 9.1 错误监控

  

```TypeScript
// lib/logger.ts
export const logger = {
  error: (message: string, error?: Error, context?: any) => {
    console.error(`[ERROR] ${message}`, {
      error: error?.message,
      stack: error?.stack,
      context,
      timestamp: new Date().toISOString()
    });
  },
  
  info: (message: string, context?: any) => {
    console.log(`[INFO] ${message}`, {
      context,
      timestamp: new Date().toISOString()
    });
  },
  
  warn: (message: string, context?: any) => {
    console.warn(`[WARN] ${message}`, {
      context,
      timestamp: new Date().toISOString()
    });
  }
};
```

  

### 9.2 性能监控

  

```TypeScript
// 性能监控中间件
const performanceMiddleware = (handler: Function) => {
  return async (request: NextRequest) => {
    const start = Date.now();
    
    try {
      const response = await handler(request);
      const duration = Date.now() - start;
      
      logger.info('API请求完成', {
        method: request.method,
        url: request.url,
        duration,
        status: response.status
      });
      
      return response;
    } catch (error) {
      const duration = Date.now() - start;
      
      logger.error('API请求失败', error as Error, {
        method: request.method,
        url: request.url,
        duration
      });
      
      throw error;
    }
  };
};
```

  

## 10. 故障排除指南

  

### 10.1 常见问题

  

#### 10.1.1 数据库连接问题

  

```Bash
# 检查数据库文件权限
ls -la prisma/dev.db

# 修复权限
chmod 644 prisma/dev.db
chown www-data:www-data prisma/dev.db

# 重新生成 Prisma 客户端
npx prisma generate
```

  

#### 10.1.2 环境变量问题

  

```Bash
# 检查环境变量
pm2 env telecom-app | grep -E "DATABASE_URL|NEXTAUTH_URL"

# 设置环境变量
pm2 set telecom-app:DATABASE_URL "file:./prisma/dev.db"
pm2 set telecom-app:NEXTAUTH_URL "https://xh.nfeyre.top"

# 重启应用
pm2 restart telecom-app
```

  

#### 10.1.3 构建问题

  

```Bash
# 清理缓存
rm -rf .next
npm run build

# 检查依赖
npm audit
npm audit fix
```

  

### 10.2 日志分析

  

```Bash
# 查看应用日志
pm2 logs telecom-app --lines 100

# 查看错误日志
pm2 logs telecom-app --err --lines 50

# 实时监控日志
pm2 logs telecom-app --follow
```

  

---

  

**文档维护：** 请在每次重大更新后及时更新此开发文档

**技术支持：** 如有技术问题，请参考故障排除指南或联系开发团队

**版本控制：** 使用 Git 进行版本控制，并遵循语义化版本规范